<script>
    const identity = _ => _;

    const sidebar = document.querySelector(".sidebar");

    const THRESHOLDS = {
        POSITIVE: 0.2,
        NEGATIVE: -0.2
    }

    function renderAnnotations(annotations) {
        console.log(annotations);

        sidebar.classList.remove("loading");
        // fun fact: this while loop executes faster than setting inner HTML to an empty string
        while (sidebar.firstChild) {
            sidebar.removeChild(sidebar.firstChild);
        }

        const documentSentimentLabel = createLabel("Document Sentiment");
        const documentSentiment = document.createElement("p");
        documentSentiment.classList.add("sentiment");
        documentSentiment.textContent =
            annotations.documentSentiment.score > THRESHOLDS.POSITIVE
                ? "ðŸ˜€" :
                annotations.documentSentiment.score < THRESHOLDS.NEGATIVE
                    ? "ðŸ˜ž" : "ðŸ˜";
        sidebar.append(documentSentimentLabel, documentSentiment);

        const mostRelevantLabel = createLabel("Most Relevant Items");
        const mostRelevantStrategy = document.createElement("select");
        const salienceStrategy = document.createElement("option");
        salienceStrategy.textContent = "Salience";
        salienceStrategy.value = "salience";
        const sentimentMagnitudeStrategy = document.createElement("option");
        sentimentMagnitudeStrategy.textContent = "Emotion";
        sentimentMagnitudeStrategy.value = "magnitude";
        mostRelevantStrategy.append(
            salienceStrategy,
            sentimentMagnitudeStrategy
        );

        const mostRelevantItems = document.createElement("ol");
        annotations.entities
            .map(identity)
            .sort((a, b) => b.salience - a.salience)
            .slice(0, 5)
            .forEach(entity => {
                const listItem = document.createElement("li");
                listItem.textContent = `${entity.name}`;
                mostRelevantItems.append(listItem);
            });
        sidebar.append(mostRelevantLabel, new Text("By "), mostRelevantStrategy, mostRelevantItems);

        const mostEmotionalSentences = createLabel("Most Emotional Sentences");
        const mostEmotionalItems = document.createElement("ol");
        mostEmotionalItems.classList.add("no-list-style");

        annotations.sentences
            .map(identity)
            .sort((a, b) => b.sentiment.magnitude - a.sentiment.magnitude)
            .slice(0, 5)
            .forEach(sentence => {
                const listItem = document.createElement("li");
                const sign = document.createElement("span");
                sign.classList.add("sign", sentence.sentiment.score > THRESHOLDS.POSITIVE ? "positive" : sentence.sentiment.score < THRESHOLDS.NEGATIVE ? "negative" : "mixed");
                sign.textContent = sentence.sentiment.score > THRESHOLDS.POSITIVE ? "+" : sentence.sentiment.score < THRESHOLDS.NEGATIVE ? "-" : "Â±";
                listItem.append(sign, new Text(sentence.text.content));

                mostEmotionalItems.append(listItem);
            });
        sidebar.append(mostEmotionalSentences, mostEmotionalItems);

        const sentimentFluctuationChart = createCanvas("Sentiment Fluctuation")
        const sentimentGradient = createStrokeGradient(sentimentFluctuationChart);
        const sentimentBgGradient = createBackgroundGradient(sentimentFluctuationChart);

        // noinspection JSUnresolvedFunction
        new Chart(sentimentFluctuationChart, {
            type: "line",
            data: {
                labels: annotations.sentences.map(sentence => sentence.text.content),
                datasets: [{
                    label: "Sentiments Fluctuation",
                    data: annotations.sentences.map(sentence => sentence.sentiment.score),
                    backgroundColor: sentimentBgGradient,
                    borderColor: sentimentGradient,
                    pointBorderColor: sentimentGradient,
                    pointBackgroundColor: sentimentGradient,
                    pointHoverBackgroundColor: sentimentGradient,
                    pointHoverBorderColor: sentimentGradient
                }]
            },
            options: {
                layout: {
                    padding: {
                        right: 8
                    }
                },
                legend: {
                    display: false,
                },
                tooltips: {
                    enabled: false
                },
                scales: {
                    xAxes: [{
                        display: false
                    }],
                    yAxes: [{
                        ticks: {
                            suggestedMin: -1,
                            suggestedMax: 1
                        }
                    }]
                }
            }
        })
    }

    function createLabel(text) {
        const label = document.createElement("h1");
        label.textContent = text;
        return label;
    }

    function createStrokeGradient(chartCanvas) {
        const ctx = chartCanvas.getContext("2d");
        const gradient = ctx.createLinearGradient(
            chartCanvas.width / 2, 0,
            chartCanvas.width / 2, chartCanvas.height
        );
        gradient.addColorStop(0, "#6100caff");
        gradient.addColorStop(1, '#e000caff');
        return gradient;
    }

    function createBackgroundGradient(chartCanvas) {
        const ctx = chartCanvas.getContext("2d");
        const bgGradient = ctx.createLinearGradient(
            chartCanvas.width / 2, 0,
            chartCanvas.width / 2, chartCanvas.height
        );
        bgGradient.addColorStop(0, "#6100caaa");
        bgGradient.addColorStop(1, '#e000caaa');
        return bgGradient;
    }

    function createCanvas(name) {
        const label = document.createElement("h1");
        label.textContent = name;

        const chartCanvas = document.createElement("canvas");

        chartCanvas.classList.add("chart");
        chartCanvas.width = sidebar.getBoundingClientRect().width - 24;
        chartCanvas.height = chartCanvas.width * 0.75;

        sidebar.append(label, chartCanvas);

        return chartCanvas;
    }


    // noinspection JSUnresolvedVariable, JSUnresolvedFunction
    google.script.run
        .withSuccessHandler(renderAnnotations)
        .withFailureHandler(console.error)
        .runAnalysis();
</script>
